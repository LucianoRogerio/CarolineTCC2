---
title: "PhenoData"
author: "LucianoRogerio; Caroline Cardoso"
date: "2021-10-25"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---


## Ajuste dos dados fenotípicos para rodar a análise de modelos mistos

Traits

| Trait | Abbreviation |
| :---: | :----------: |
| Produtividade de Raizes Comerciais | PCR |
| Produtividade Total de Raizes | PTR |
| Produtividade de parte Aerea | PPA |
| Indice de Colheita | IC |
| Altura de Planta | AP |
| Numero de manivas por haste | NMa |
| Teor de Materia Seca Balanca Hidrostatica | DMCsg |
| HCN Laboratorio | HCNLab |
| Produtividade de Materia seca | DRY |
| Porte de Planta | PA |
| Produtividade de Raizes nao Comerciais | PNCR |
| Vigor | Vigor |
| Retencao Foliar | RF |
| Numero de Raizes por planta | NR |
| Peso de Raizes | PR |
|     |     |


```{r Ajuste dos dados fenotipicos}
suppressWarnings(suppressMessages(library(tidyverse)))
library(reshape2); library(here)
DadosPhen <- read.table(here::here("data", "DadosFen2Cap.csv"),
                        header = T, sep = ",", na.strings = "")
unique(DadosPhen$Genotipos.BGM) %>% .[order(.)]
colnames(DadosPhen)[c(9:40, 46:55)] <- c("Stand", "PRC", "PRNC", "PTR", "PPA", "DMCsg",
                                         "DRY", "IC", "AP", "NMa", "PA", "Vigor45D",
                                         "Vigor12M", "RF", "PRz", "NRz", "PPD", "Pod",
                                         "PodRCas", "PodRPol", "FrogSkin", "CorPol",
                                         "Friab", "MoscBc", "MoscBr", "MurPA", "MosCm",
                                         "MosNv", "AcSev", "BacSev", "FerSev", "SupASev",
                                         paste0("HCN-",1:9), "TCC")

DadosPhen <- DadosPhen %>% mutate(Cook = ifelse(Cook15 == 1,
                                                yes = "15",
                                                no = ifelse(Cook20 == 1,
                                                            yes = "20",
                                                            no = ifelse(Cook25,
                                                                        yes = "25",
                                                                        no = ifelse(Cook30 == 1,
                                                                                    yes = "30",
                                                                                    no = ifelse(Cook40 == 1,
                                                                                                yes = "40",
                                                                                                no = ifelse(Cook40 == 0,
                                                                                                            yes = ">40",
                                                                                                            no = NA))))))) %>% 
  mutate(Cook = factor(Cook, levels = c("15", "20", "25", "30", "40", ">40"), ordered = T)) %>%
  dplyr::select(-Cook15, -Cook20, -Cook25, -Cook30, -Cook40)

colnames(DadosPhen)[c(1:40,50:51)]

DadosParQuant <- DadosPhen[,c(1:29,32:40,50)]
DadosParQual <- DadosPhen[,c(1:9,30:31,51)]


DadosParQuantFin <- DadosParQuant %>% reshape2::melt(data = ., id.vars = c(1:9),
                                           variable.name = "Trait", value.name = "y") %>%
  filter(!is.na(y)) %>%
  dplyr::mutate(Ano = Ano,
                Campo = Campo,
                Local = Local,
                trial = match(paste(Ano, Campo, Local, sep = "."),
                              unique(paste(Ano, Campo, Local, sep = "."))),
                clone = Genotipos.BGM,
                y = as.numeric(y), .keep = "unused")


DadosParQualFin <- DadosParQual %>% group_by(Genotipos.BGM) %>%
  summarise(CorPol = table(CorPol) %>%
              .[order(., decreasing = T)] %>% .[1] %>% names %>% as.integer(),
            Friab = table(Friab) %>%
              .[order(., decreasing = T)] %>% .[1] %>% names %>% as.character(),
            Cook = table(Cook) %>%
              .[order(., decreasing = T)] %>% .[1] %>% names %>% as.character())

saveRDS(DadosParQualFin, file = here::here("output", "DadosQualCaroline.rds"))

DadosHCN <- DadosPhen[,c(1:9, 41:49)]

DadosHCNFin <- DadosHCN %>% reshape2::melt(data = ., id.vars = c(1:9),
                                           variable.name = "HCN",  value.name = "y") %>%
  filter(!is.na(y)) %>%
  mutate(Ano = Ano,
         Campo = Campo,
         Local = Local,
         trial = match(paste(Ano, Campo, Local, sep = "."),
                       unique(paste(Ano, Campo, Local, sep = "."))),
         clone = Genotipos.BGM, .keep = "unused")

DataCar <- tibble(Traits = unique(DadosParQuantFin$Trait),
                  PhenData = NA)

for(i in DataCar$Traits){
DataCar$PhenData[DataCar$Traits == i] <- list(DadosParQuantFin %>% filter(Trait == i))
}

DataCar <- DataCar %>% rbind(tibble(Traits = "HCN",
                                    PhenData = list(DadosHCNFin)))

saveRDS(object = DataCar, file = here::here("data", "DadosPhenCar.rds"))
```

### Selecionar os ensaios utilizando Herdabilidade e R2 estimados funções de Modelos mistos

```{r Modelos mistos Selecao de dados fenotipicos, warning = FALSE, message = FALSE}
suppressWarnings(suppressMessages(library(tidyverse)))
library(MuMIn)
library(reshape2); library(here)

suppressMessages(source(here::here("code", "MixedModelsFunctions.R")))

DadosCar <- readRDS(file = here::here("data", "DadosPhenCar.rds"))


require(furrr); plan(multisession, workers = 3)
DataCar <- DataCar %>% dplyr::mutate(TrialSel = future_map2(Traits, PhenData, function(Traits, PhenData,...){
  Trials <- unique(PhenData$trial)
  PhenData
  results <- tibble()
    for(i in Trials) {
  try(MixedModels <- analyzeTrial.lme4(PhenData %>% filter(trial %in% i)))
  try(result <- tibble(Trial = i,
                       Trait = Traits,
                       NClones = nrow(unique(PhenData %>%
                                                 filter(trial %in% i) %>% 
                                                 dplyr::select(clone))),
                       VarG = as.data.frame(VarCorr(MixedModels))[,c("grp","vcov")] %>% .[1,2],
                       VarE = as.data.frame(VarCorr(MixedModels))[,c("grp","vcov")] %>% .[2,2],
                       H2 = VarG/(VarG + VarE),
                       Real = suppressWarnings(MuMIn::r.squaredGLMM(MixedModels)[2])))
  try(results <- rbind(results, result))
    }
  return(results = results)
  }))

Results <- DataCar %>% dplyr::select(TrialSel) %>% unnest_longer(TrialSel) %>% .[[1]]
```

### Seleção ensaios Dados Fenotipicos

```{r Obtencao da Herdabilidade e Confiabilidade do modelo para cada ensaio, echo = FALSE}
library(reactable)
TrialsList <- unique(DadosParQuantFin[,c("Ano", "Campo", "Local", "trial")])

Results2 <- Results %>% right_join(TrialsList, by = c("Trial" = "trial")) %>%
  dplyr::select(Trial, Ano, Campo, Local, everything()) %>% mutate(Selecionado = ifelse(Real > 0.25 & H2 > 0.15, "Sim", "Nao"))

Results2 %>% reactable(groupBy = c("Trait"), columns = list(
  VarG = colDef(format = colFormat(digits = 2, locales = "en-US")),
  VarE = colDef(format = colFormat(digits = 2, locales = "en-US")),
  H2 = colDef(format = colFormat(digits = 3, locales = "en-US")),
  Real = colDef(format = colFormat(digits = 3, locales = "en-US"))))
```

```{r Filtrando dados fenotipicos}
DataSelPar <- DadosParQuantFin %>% mutate(Trait.Trial = paste(Trait, trial, sep = ".")) %>%
  .[.$Trait.Trial %in% (Results2 %>% mutate(Trait.Trial = paste(Trait, Trial, sep = ".")) %>%
                        filter(Selecionado == "Sim") %>% .$Trait.Trial),]


DataCar <- tibble(Traits = unique(DataSelPar$Trait),
                  PhenData = NA)

for(i in DataCar$Traits){
DataCar$PhenData[DataCar$Traits == i] <- list(DataSelPar %>% filter(Trait == i))
}
```


## Selecao de ensaios de avaliacao de HCN

```{r Filtrando dados HCN}
DataSelHCN <- DadosHCNFin %>% mutate(Trait.Trial = paste("HCN", trial, sep = ".")) %>% 
  .[.$Trait.Trial %in% (Results2 %>% mutate(Trait.Trial = paste(Trait, Trial, sep = "."))
                        %>% filter(Selecionado == "Sim", NClones >= 20) %>% .$Trait.Trial),]

DataCar <- DataCar %>% rbind(tibble(Traits = "HCN",
                                    PhenData = list(DataSelHCN)))

saveRDS(object = DataCar, file = here::here("data", "DadosPhenSelCar.rds"))
```

### Estimação BLUPS e obtenção de médias corrigidas

```{r Obtendo BLUPs e médias corrigidas dos acessos, warning = FALSE, eval = F}
library(here)
library(furrr)
library(tidyverse)
source(here::here("code", "MixedModelsFunctions.R"))
library(elliptic)

DataCar <- readRDS(here::here("data", "DadosPhenSelCar.rds"))

plan(multicore(workers = 3))

PhenData <- DataCar$PhenData[[27]]

DataCar %>% mutate(Blups = future_map2(Traits, PhenData, function(Traits, PhenData,...){
  RhpcBLASctl::blas_set_num_threads(3)
  print(paste("Trait", Traits, sep = " "))
  PhenData <- PhenData %>%
    mutate(trial = as.character(trial),
           rep = as.character(Bloco),
           repTrial = as.factor(paste(trial, Bloco, sep = ":")),
           LocYear = as.factor(paste(Local, Ano, sep = ":")))
  
  MM <- analyzeTrial.sommerConj(PhenData)
  blups <- MM$U$clone$y + MM$Beta$Estimate
  Blups <- tibble(id = names(blups),
                  blups = blups) %>%
    dplyr::mutate(id = gsub(pattern = "clone", replacement = "",x = .$id))
  colnames(Blups)[2] <- Traits
  file <- here::here("output", "MixedModels",
                     paste("Blups_", Traits, ".rds", sep = ""))
  saveRDS(object = Blups, file = file)
  return(Blups)
}))
  

}


BlupsTraits <- readRDS(here::here("output", "MixedModels", "Blups_HCNPic.rds"))
IDClones <- tibble(id = unique(c(DataSelPar$clone, DataSelHCN$clone)) %>% .[order(.)])
BlupsTraits <- IDClones %>% left_join(BlupsTraits, by = "id")
traits2 <- traits %>% .[-c(1,15:17)]

for(i in traits2){
  filename <- paste("Blups_", i, ".rds", sep = "")
  BlupsTraits <- BlupsTraits %>%
    left_join(readRDS(here::here("output", "MixedModels", filename)))
  colnames(BlupsTraits)[colnames(BlupsTraits) == "blups"] <- i
}

saveRDS(object = BlupsTraits,
        file = here::here("output", "BlupsFenCar.rds"))
```

### Juntar as estimativas de caracteristicas quantitativos e qualitativos

```{r Agrupar as caracteristicas}
library(tidyverse); library(data.table)
Blups <- readRDS(here::here("output", "BlupsFenCar.rds"))
DataPhen <- read.table(here::here("data", "DadosCarolineNBlups.csv"),
                       sep = ",", header = TRUE)

# Removendo caracteres duplicados

Blups <- Blups %>% dplyr::select(-HCNLab, -DMCoven, -APsF, -PR, -TAC, -PRNC)

# Conferindo nomes dos clones em ambos os objetos
DataPhen$Acessos[!DataPhen$Acessos %in% Blups$id]
Blups$id[!Blups$id %in% DataPhen$Acessos]

sum(DataPhen$Acessos %in% Blups$id)
sum(Blups$id %in% DataPhen$Acessos)
# Juntando os objetos em um unico

AllDataInfo <- inner_join(DataPhen, Blups, by = c("Acessos" = "id"))  %>%
  mutate(CorFolhaApical = as.character(CorFolhaApical),
         CorPeciolo = as.character(CorPeciolo),
         CorFolhaDesenv = as.character(CorFolhaDesenv),
         CorNerv = as.character(CorNerv),
         CorCortexCaule = as.character(CorCortexCaule),
         CorExternaCaule = as.character(CorExternaCaule),
         CorEpidCaule = as.character(CorEpidCaule),
         CorRamosTerm = as.character(CorRamosTerm),
         CorExternaRzs = as.character(CorExternaRzs),
         CorCortexRzs = as.character(CorCortexRzs),
         CorPolpaRzs = as.character(CorPolpaRzs),
         Pubescencia = as.character(Pubescencia),
         FormaLobuloCentral = as.character(FormaLobuloCentral),
         PosicaoPeciolo = as.character(PosicaoPeciolo),
         Sinuosidade = as.character(Sinuosidade),
         HabCrescCaule = as.character(HabCrescCaule),
         TipoPlan = as.character(TipoPlan),
         MargEstip = as.character(MargEstip),
         HabRamif = as.character(HabRamif),
         NiveisRam = as.character(NiveisRam),
         ProemCicatrizesFolhas = as.character(ProemCicatrizesFolhas),
         FormaRzs = as.character(FormaRzs),
         TxtEpidermeRzs = as.character(TxtEpidermeRzs),
         PresPedunculoRzs = as.character(PresPedunculoRzs),
         PosicaoRzs = as.character(PosicaoRzs),
         Flowering = as.character(Flowering),
         DestqPelicRz = as.character(DestqPelicRz),
         DestqCortexRz = as.character(DestqCortexRz),
         ConstrRzs = as.character(ConstrRzs))

# Conferindo o número de dados perdidos por característica

TraitsSel <- names(colSums(is.na(AllDataInfo)))[colSums(is.na(AllDataInfo))/nrow(AllDataInfo) < 0.30]

# Imputando dados perdidos
AllDataInfo <- AllDataInfo[,TraitsSel]
traits <- colnames(AllDataInfo)[-1]
sum(is.na(AllDataInfo))
for(i in traits){
  if(class(AllDataInfo[,i]) == "character"){
  # Imputando a moda para dados qualitativos
        AllDataInfo[,i][is.na(AllDataInfo[,i])] <- table(AllDataInfo[,i]) %>%
      .[order(., decreasing = T)] %>% .[1] %>% names %>% as.integer
  } else {
  # Imputando a media para dados quantitativos
    AllDataInfo[,i][is.na(AllDataInfo[,i])] <- mean(AllDataInfo[,i], na.rm = TRUE)
  }
}

saveRDS(AllDataInfo, file = here::here("output", "DataSelPreparedCar.rds"))
```

## Estimação Blups Carotenóides de Predições NIR ASD

```{r}
library(sommer)
DataCar <- read.table(file = here::here("data", "Preditos_TCC_ASD_PLS_18-20.txt"),
                      header = T, sep = "\t", na.strings = "")
head(DataCar)

mod <- lmer(formula = TCC ~ Trial + (1|Clone),
            data = DataCar)
anova(mod)
summary(mod)
fixef(mod)
ranef(mod)
Blups <- tibble(clones = ranef(mod)$Clone %>% rownames,
                TCC = ranef(mod)$Clone[,1] + fixef(mod)[[1]])

```

## New data

```{r}
Newdata <- read.table(file = here::here("data", "DadosFen2Cap.csv"), sep = ",",
                      header = T, na.strings = "")
NewData <- Newdata %>%
  mutate(CookTime = ifelse(Cook15 == "Sim", yes = "15",
                           no = ifelse(Cook20 == "Sim", yes = "20",
                                       no = ifelse(Cook25 == "Sim", yes = "25",
                                                   no = ifelse(Cook30 == "Sim", yes = "30",
                                                               no = ifelse(Cook40 == "Sim", yes = "40",
                                                                           no = ifelse(is.na(.), NA, ">40")))))),
         .keep = "unused") %>% rename(Genotipos.BGM. = Genotipos.BGM)
table(NewData$CookTime)
colnames(NewData)
colnames(DadosPhen)
test <- DadosPhen %>% inner_join(NewData)

test2 <- test %>% filter(!is.na(RetencaoFoliar))
cbind(test2$Retencao.foliar....CO_334.0000048,test2$RetencaoFoliar)
```

```{r Joint all data per Thematic collection}

## Temática 1 - Produtividade de Raízes
TC1Traits <- c("IC", "PTR", "NR", "DRY", "DMCsg", "PPA")
TC1Traits <- c("PTR", "NR", "DRY", "DMCsg") ## IC and PPA not finished their Mixed Models analysis

## Temática 2 - Resistência a Doenças Foliares
TC2Traits <- c("Anth", "BlLS", "BrLS", "WhLS", "Germinação 45DAP", "Couro de sapo", "Podridao", "Retencao foliar")

## Temática 3 - Qualidade das raízes
# Verificar conjunto de dados de deteorização Fisiológica com Eder e predições de Carotenóides e DMC com Massaine
# Fazer uma coleção para Coloração Branca e uma para coloração amarela
TC3Traits <- c("HCNPic", "DMCsg", "PPD", "TCC", "CorPolpa", "Podridao",
               "Cook15", "Cook20", "Cook25", "Cook30", "Cook40")

```


Next - [Dados Moleculares - Seleção](GenoData.html)

[Home](index.html)
